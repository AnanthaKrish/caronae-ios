defaults: &defaults
  working_directory: /Users/distiller/project
  macos:
    xcode: "9.2.0"
  environment:
    FL_OUTPUT_DIR: /Users/distiller/project/output
  shell: /bin/bash --login -o pipefail

version: 2
jobs:
  build:
    <<: *defaults
    steps:
      - checkout
      - run:
          name: Configure Git
          command: |
            git config --global user.email "circleci@caronae.org"
            git config --global user.name "CircleCI"
      - restore_cache:
          key: 1-gems-{{ checksum "Gemfile.lock" }}
      - run: bundle check || bundle install --path vendor/bundle
      - save_cache:
          key: 1-gems-{{ checksum "Gemfile.lock" }}
          paths:
            - vendor/bundle
      - restore_cache:
          key: 1-pods-{{ checksum "Podfile.lock" }}
      - run:
          name: Fetch CocoaPods specs
          command: curl https://cocoapods-specs.circleci.com/fetch-cocoapods-repo-from-s3.sh | bash -s cf
      - run:
          name: Build app
          command: bundle exec fastlane build
      - save_cache:
          key: 1-pods-{{ checksum "Podfile.lock" }}
          paths:
            - Pods
      - store_artifacts:
          path: output/buildlogs
      - persist_to_workspace:
          root: /Users/distiller/project
          paths:
            - .bundle
            - vendor
            - Gemfile
            - fastlane
            - output/gym/Caronae.ipa
            - output/gym/Caronae.app.dSYM.zip

  deploy_testflight:
    <<: *defaults
    steps:
      - attach_workspace:
          at: output
      - run:
          name: Build and publish app to TestFlight
          command: bundle exec fastlane beta skip_build:true

  deploy_appstore:
    <<: *defaults
    steps:
      - run:
          name: Build and publish app to App Store
          command: bundle exec fastlane deploy skip_build:true

workflows:
  version: 2

  build_app:
    jobs:
      - build
      - deploy_testflight:
          requires:
            - build
          filters:
            branches:
              only:
                - master
      - deploy_appstore:
          type: approval
          requires:
           - build
